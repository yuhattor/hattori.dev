---
title: "ソースコードアーカイブとハッシュの今後の安定性に関する最新情報"
subtitle: "1月30日に何が起こったのか、サプライズを防ぐためにどのような対策をとっているのか、そして今後の変更にどのように対処していくのかをご紹介します。"
englishsubtitle: "A look at what happened on January 30, what measures we’re putting in place to prevent surprises, and how we’ll handle future changes."
englishtitle: "Update on the future stability of source code archives and hashes"
date: "2023-02-21"
cardurl: "https://github.blog/2023-02-21-update-on-the-future-stability-of-source-code-archives-and-hashes/"
author: "Matt Cooper"
description: " On January 30, 2023, GitHub deployed a change which slightly altered the compression settings on source code downloads. This change had unforeseen consequences for a number of communities, and after they let us know, we rolled the change back. We’d like to explain what happened, what measures we’re putting in place to prevent surprises, and how we’ll handle future changes.  Here’s what happened  Source downloads on GitHub depend on Git’s archive command. Because of the volume of data on GitHub, we don’t keep git archive results permanently. They’re cached for a time, then deleted and recreated if requested again. This strikes a good balance between making releases, tags, and even arbitrary commits available without ballooning our storage needs to an unsustainable level.  On January 30, we deployed Git 2.38 to the service that powers source downloads. This version of Git changed the default compression command used for git archive generation from external gzip to an internal copy of gzip . Although the files contained in the archive were identical, small changes to compression settings meant that the byte layout of the archive itself changed. This in turn meant that any hash or checksum (think SHA256, CRC64, etc.) of the archive also changed.  As it turned out, many communities had built assumptions about source downloads and their hashes. To help ensure reproducibility and/or "
coverimage: "https://github.blog/wp-content/uploads/2022/06/Engineering-Product@2x.png?resize=1600%2C850"
category: "Product,Git"
englishsummary: "  GitHub deployed a change which caused unexpected problems for some communities and was subsequently rolled back, and they are now implementing measures to prevent similar surprises in the future."
summary: "  GitHubは、一部のコミュニティで予期せぬ問題を引き起こす変更を展開し、その後ロールバックされましたが、今後同様のサプライズを防止するための対策を実施中とのことです。"
---

<p>2023年1月30日、GitHubはソースコードのダウンロード時の圧縮設定を若干変更する変更を導入しました。この変更は、多くのコミュニティにとって予期せぬ結果となり、その報告を受けた後、私たちはこの変更を元に戻しました。何が起こったのか、予期せぬ事態を防ぐためにどのような対策をとっているのか、そして今後の変更にどのように対処するのかを説明したいと思います。</p>
<h2 id="heres-what-happened">以下がその内容です。<a href="#heres-what-happened" class="heading-link pl-2 text-italic text-bold" aria-label="Here’s what happened"></a></h2>
<p>GitHubでのソースのダウンロードは、<a href="https://git-scm.com/docs/git-archive">Gitのarchive</a>コマンドに依存しています。GitHubのデータ量が多いため、私たちは<code>gitアーカイブの</code>結果を永久に保持しません。一時的にキャッシュされ、その後削除され、再び要求されたら再作成されます。これは、リリースやタグ、そして任意のコミットを、ストレージの必要量を維持できないレベルまで膨らませることなく利用できるようにするための、良いバランスを保っているのです。</p>
<p><img decoding="async" src="https://github.blog/wp-content/uploads/2023/02/stable-archive-1.png?w=1024&#038;resize=1024%2C293" alt="" width="1024" height="293" class="aligncenter size-large wp-image-70196 width-fit" srcset="https://github.blog/wp-content/uploads/2023/02/stable-archive-1.png?w=1152 1152w, https://github.blog/wp-content/uploads/2023/02/stable-archive-1.png?w=300 300w, https://github.blog/wp-content/uploads/2023/02/stable-archive-1.png?w=768 768w, https://github.blog/wp-content/uploads/2023/02/stable-archive-1.png?w=1024&#038;resize=1024%2C293 1024w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1" /></p>
<p>1月30日には、ソースのダウンロードを支援するサービスにGit 2.38をデプロイしました。このバージョンのGitは、<code>gitアーカイブの</code>生成に使われる<a href="https://github.com/git/git/commit/4f4be00d30">デフォルトの圧縮コマンドを</a>、外部の<code>gzipから</code>内部の<code>gzipの</code>コピーに<a href="https://github.com/git/git/commit/4f4be00d30">変更</a>しました。アーカイブに含まれるファイルは同一でしたが、圧縮設定の小さな変更は、アーカイブ自体のバイトレイアウトが変わることを意味しました。これは、アーカイブの<a href="https://en.wikipedia.org/wiki/Hash_function">ハッシュや</a> <a href="https://en.wikipedia.org/wiki/Checksum">チェックサム</a>(SHA256, CRC64 など) も変化することを意味します。</p>
<p>その結果、多くのコミュニティがソースのダウンロードとそのハッシュについて仮定していることが判明しました。再現性やセキュリティを確保するために、多くのシステムはアーカイブを一旦集中的にダウンロードし、そのハッシュを自分たちのリポジトリに記録しています。後でユーザーが GitHub からアーカイブをダウンロードすると、そのクライアントは自動的にアーカイブのハッシュを、先に記録されたものと照合します。もし不一致があれば、クライアントは処理を拒否します（何かが変わったのであれば、それが改ざんされたものなのか、壊れたダウンロードなのか、それとも他のものなのかを人間が判断する必要がある、という仮定で）。</p>
<h2 id="was-this-a-surprise">これは驚きでしたか？<a href="#was-this-a-surprise" class="heading-link pl-2 text-italic text-bold" aria-label="Was this a surprise?"></a></h2>
<p>イエスでもありノーでもあります。私たちは、<code>git archive</code>コマンドのデフォルトが変更されたことは知っていました。予想外だったのは、このことが多くのコミュニティに広く影響を与えるかもしれないということです。</p>
<p>内部的には、私たちは長い間<code>git archiveの</code>バイト単位の安定性を保証すべきではないと考えてきました。デフォルトや利用可能なオプションさえも、Gitプロジェクトによってコントロールされており、同様にそのような保証はしていないのです。私たちは、私たちがフォークしたGitと上流のGitとの間の差異を最小にするよう努力しています。したがって、<code>アーカイブの</code>コードに恒久的なパッチを持ち込むことは避けたいと考えています。</p>
<p>しかし、今回の事件で、私たちはこのスタンスを必ずしも明確にしていなかったことを知りました。今、私たちがすべきことは、このスタンスをコミットすることです。このコミットメントに加え、私たちは開発サイクルにテストを追加し、将来的な変更をGitHub.comに反映する前に検出できるようにします。(GitHub Docsはこのコミットメントを反映するためにまもなく更新されます)</p>
<h2 id="future-stability-of-archives-and-hashes">アーカイブとハッシュの将来的な安定性<a href="#future-stability-of-archives-and-hashes" class="heading-link pl-2 text-italic text-bold" aria-label="Future stability of archives and hashes"></a></h2>
<ol>
<li>GitHubは、今日から1年以上（2023年2月21日）、ダウンロードしたソースをバイト単位で安定的に保持する予定です。これはtarball (.tar.gz) とzipball (.zip)の両方の形式をカバーしています。</li>
<li>将来、どちらかのアーカイブ形式を変更する場合は、6ヶ月前にドキュメント、ブログ、変更履歴でお知らせします。(圧縮パスに重大な脆弱性が発見された場合、私たちのシステムとお客様を保護するために、通知期間を短縮または省略する権利を留保します。このような結果は想定していませんが、わからないものです)。</li>
<li>この変更がもたらす影響の大きさを改めて認識したため、現在のところ、どちらのフォーマットも変更するつもりはありません。完全な透明性を保つために、私たちが修正したいと思ういくつかの欠陥 (zipball に埋め込まれたタイムスタンプ、tarball のシステム<code>gzip</code>への依存) がありますが、当面の間、私たちはこれらの小さな問題を回避するように設計します。</li>
</ol>
<p>もしあなたが再現性のためだけに安定したアーカイブに依存しているのなら (アーカイブの中に常に同一のファイルがあることを保証するため)、私たちはソースアーカイブを<a href="https://docs.github.com/rest/repos/contents#download-a-repository-archive-tar">ソースアーカイブ REST API を使って</a>、<code>:ref</code>パラメータにコミット ID を指定してダウンロードすることをお勧めします。ハッシュを記録する必要はありません。コミットIDによって、アーカイブ内のファイルの内容が常に同じであることが保証されるからです。GitとGitHubは、コミットIDの生成方法の性質上、これを保証しています。コミットIDを使うことで、リポジトリがタグを書き換えたりブランチヘッドを移動したりしても、影響を受けないようになります。tarball と zipball の形式には、切り捨てに対する保護が組み込まれています。また、TLS (HTTPSによる) によってアーカイブの破損を防いでいます。</p>
<p>セキュリティのために安定したアーカイブに依存している場合 (たとえば、誤って tarbomb を起動しないようにする)、ソースのダウンロードを使う代わりに、リリースアセットに切り替えることをお勧めします。リリースページでは、GitHubにアップロードされたアセットがファイルサイズとともに表示されます。ファイルは、ウェブから手動で追加するか、<a href="https://github.com/softprops/action-gh-release">この（サードパーティ製の）GitHub Actionの</a>ようなものを使ってリリースに追加することができます。後で<a href="https://docs.github.com/rest/releases/assets#get-a-release-asset">Release Assets REST API を</a>使ってファイルを取得することもできます。リリースアセットに依存することが不可能な場合は、将来の（頻繁ではない）ハッシュの変更に対応できるような設計を検討することを強くお勧めします。</p>
<p><img decoding="async" loading="lazy" src="https://github.blog/wp-content/uploads/2023/02/stable-archive-2.png?w=1024&#038;resize=1024%2C345" alt="" width="1024" height="345" class="aligncenter size-large wp-image-70197 width-fit" srcset="https://github.blog/wp-content/uploads/2023/02/stable-archive-2.png?w=1328 1328w, https://github.blog/wp-content/uploads/2023/02/stable-archive-2.png?w=300 300w, https://github.blog/wp-content/uploads/2023/02/stable-archive-2.png?w=768 768w, https://github.blog/wp-content/uploads/2023/02/stable-archive-2.png?w=1024&#038;resize=1024%2C345 1024w" sizes="(max-width: 1000px) 100vw, 1000px" data-recalc-dims="1" /></p>


